<VirtualHost *:443>
    ServerName www.unix.com
    ServerAlias unix.com
    DocumentRoot /var/www/
    LogLevel crit ssl:crit reqtimeout:crit

    <Directory /var/www>
        AllowOverride All
        Require all granted
    </Directory>

    Include /etc/apache2/unix_redirect/logging_blocks.conf

    RewriteEngine On
# Serve the 410 body from /410 (which is proxied to Rails above)
ErrorDocument 404 /404
ErrorDocument 410 /410

# --- Explicit carve-out (belt + suspenders) ---
RewriteRule ^man_page_missing\.png$ - [L]

RewriteRule ^assets/(.*)$ https://community.unix.com/assets/$1 [R=301,L,NE]
RewriteRule ^theme-javascripts/(.*)$ https://community.unix.com/theme-javascripts/$1 [R=301,L,NE]


    # 1) OLD dbseositemap entrypoint -> new sitemap index
    RewriteCond %{REQUEST_URI} ^/dbseositemap\.php [NC]
    RewriteRule ^/dbseositemap\.php.*$ /sitemap.xml [R=301,L,QSD]

#RewriteCond %{QUERY_STRING} .
#RewriteCond %{REQUEST_URI} \.php [NC]
#RewriteRule ^ http://127.0.0.1:3001/410 [P,L]
    # Strip query strings
    RewriteCond %{QUERY_STRING} .
    RewriteRule ^ %{REQUEST_URI} [QSD]

# --- Google Search Console verification file: do not rewrite/redirect ---
RewriteRule ^/google331abbadbc72e0cb\.html$ - [L]

    # Do NOT redirect the main sitemap.xml
RewriteCond %{REQUEST_URI} ^/sitemap\.xml$ [NC]
RewriteRule ^ - [L]

# Optional: don't redirect any sitemap shards under /sitemaps/
RewriteCond %{REQUEST_URI} ^/maps/new_sitemaps/ [NC]
RewriteRule ^ - [L]


    # 2) Gzipped sitemap index variant -> plain sitemap.xml
    RewriteCond %{REQUEST_URI} ^/sitemap\.xml\.gz [NC]
    RewriteRule ^/sitemap\.xml\.gz.*$ /sitemap.xml [R=301,L,QSD]

    # OLD dbmaps sitemap files -> new sitemap index
RewriteCond %{REQUEST_URI} ^/maps/dbmaps/ [NC]
RewriteRule ^/maps/dbmaps/.*$ /sitemap.xml [R=301,L,QSD]

    # Allow the fast Rails test endpoint to bypass redirect.php
    RewriteCond %{REQUEST_URI} ^/fast_index/ [NC]
    RewriteRule ^(.*)$ http://127.0.0.1:3001/$1 [P,L]
    # www.unix.com homepage -> man pages "all" page
    RewriteCond %{HTTP_HOST} ^www\.unix\.com$ [NC]
    RewriteCond %{REQUEST_URI} ^/$
    RewriteRule ^(.*)$ http://127.0.0.1:3001/$1 [P,L]
  

    # Extracted logic blocks
    Include /etc/apache2/unix_redirect/kill_blocks.conf
    Include /etc/apache2/unix_redirect/proxy_blocks.conf
    Include /etc/apache2/unix_redirect/rails_static_aliases.conf

    # Kill full MMS folder
    RewriteCond %{REQUEST_URI} ^/mms/ [NC]
    RewriteRule .* - [G,L]



    # Priority manpage routes
    Include /etc/apache2/unix_redirect/manpage_priority.conf

    # Redirect.php logic
    Include /etc/apache2/unix_redirect/redirect_logic.conf

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/unix.com-0001/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/unix.com-0001/privkey.pem
</VirtualHost>

