<VirtualHost *:443>
    Include /etc/apache2/le_http_01_challenge_pre.conf
    ServerName www.unix.com
    ServerAlias unix.com
    DocumentRoot /var/www/
LogLevel crit ssl:crit reqtimeout:crit

# Serve the 410 body from /410 (which is proxied to Rails above)
ErrorDocument 404 /404
ErrorDocument 410 /410
    <Directory /var/www>
        AllowOverride All
        Require all granted
    </Directory>



# If upstream (Rails/PHP) didn't tag it, Apache originated it
    Header always set X-Origin "apache""expr=-z %{resp:X-Origin}"

RewriteEngine On


# Around line 99, add:
RewriteRule ^stellar(/.*)?$ http://127.0.0.1:3002$1 [P,L]

# Redirect search.php anywhere EXCEPT under man-page routes
RewriteRule search\.php$ https://community.unix.com/search [R=301,L,QSD]

# Must be BEFORE any ".php => 410" / [G,L] rule
#RewriteRule search\.php$ https://community.unix.com/search [R=301,L,QSD]

RewriteCond %{HTTP_HOST} ^unix\.com$ [NC]
RewriteRule ^ https://www.unix.com%{REQUEST_URI} [R=301,L]

RewriteCond %{REQUEST_URI} ^/apropos-man
RewriteRule ^apropos-man/(.*)$ /man-page/$1 [R=301,L]


Include /etc/apache2/unix_redirect/logging_blocks.conf



# then your generic php kill rule
RewriteCond %{REQUEST_URI} \.php [NC]
RewriteRule .* - [G,END]

RewriteRule ^assets/plugins/ - [G,L]
RewriteRule ^assets/(chunk|browser-detect-|start-discourse-|browser-update-|vendor) - [G,L]
RewriteRule ^stylesheets/ - [G,L]
RewriteRule ^theme-javascripts/ - [G,L]
RewriteRule ^extra-locales/ - [G,L]
RewriteRule ^images/emoji/ - [G,L]

# direct proxy to Rails search
RewriteRule "^/search$" "http://127.0.0.1:3001/search" [P,QSA]

# if needed with trailing slash:
RewriteRule "^/search/(.*)$" "http://127.0.0.1:3001/search/$1" [P,QSA]
# --- Explicit carve-out (belt + suspenders) ---
RewriteRule ^man_page_missing\.png$ - [L]

# 1) OLD dbseositemap entrypoint -> new sitemap index
RewriteCond %{REQUEST_URI} ^/dbseositemap\.php [NC]
RewriteRule ^/dbseositemap\.php.*$ /sitemap.xml [R=301,L,QSD]

#RewriteCond %{QUERY_STRING} .
#RewriteCond %{REQUEST_URI} \.php [NC]
#RewriteRule ^ http://127.0.0.1:3001/410 [P,L]

# --- Google Search Console verification file: do not rewrite/redirect ---
RewriteRule ^/google331abbadbc72e0cb\.html$ - [L]

    # Do NOT redirect the main sitemap.xml
RewriteCond %{REQUEST_URI} ^/sitemap\.xml$ [NC]
RewriteRule ^ - [L]

# Optional: don't redirect any sitemap shards under /sitemaps/
RewriteCond %{REQUEST_URI} ^/maps/new_sitemaps/ [NC]
RewriteRule ^ - [L]


# 2) Gzipped sitemap index variant -> plain sitemap.xml
RewriteCond %{REQUEST_URI} ^/sitemap\.xml\.gz [NC]
RewriteRule ^/sitemap\.xml\.gz.*$ /sitemap.xml [R=301,L,QSD]

# OLD dbmaps sitemap files -> new sitemap index
RewriteCond %{REQUEST_URI} ^/maps/dbmaps/ [NC]
RewriteRule ^/maps/dbmaps/.*$ /sitemap.xml [R=301,L,QSD]

# Allow the fast Rails test endpoint to bypass redirect.php
RewriteCond %{REQUEST_URI} ^/fast_index/ [NC]
RewriteRule ^(.*)$ http://127.0.0.1:3001/$1 [P,L]
    # www.unix.com homepage -> man pages "all" page
RewriteCond %{HTTP_HOST} ^unix\.com$ [OR]
RewriteCond %{HTTP_HOST} ^www\.unix\.com$ [NC]
RewriteCond %{REQUEST_URI} ^/$
RewriteRule ^(.*)$ http://127.0.0.1:3001/$1 [P,L]
  

# Extracted logic blocks
Include /etc/apache2/unix_redirect/kill_blocks.conf
Include /etc/apache2/unix_redirect/proxy_blocks.conf
Include /etc/apache2/unix_redirect/rails_static_aliases.conf

# Strip query strings
RewriteCond %{QUERY_STRING} .
RewriteRule ^ %{REQUEST_URI} [QSD]

# Kill full MMS folder
RewriteCond %{REQUEST_URI} ^/mms/ [NC]
RewriteRule .* - [G,L]



# Priority manpage routes
Include /etc/apache2/unix_redirect/manpage_priority.conf

# Redirect.php logic
    Include /etc/apache2/unix_redirect/redirect_logic.conf

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/unix.com-0001/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/unix.com-0001/privkey.pem
Include /etc/apache2/le_http_01_challenge_post.conf
</VirtualHost>

