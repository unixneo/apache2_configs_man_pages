<VirtualHost *:443>
    ServerName www.unix.com
    ServerAlias unix.com
    DocumentRoot /var/www/
    LogLevel crit ssl:crit reqtimeout:crit

    <Directory /var/www>
        AllowOverride All
        Require all granted
    </Directory>

    SetEnvIf Request_URI "^/mms/ping" mmsbot=1

    CustomLog ${APACHE_LOG_DIR}/man_page_ssl_access.log combined env=!mmsbot
    CustomLog ${APACHE_LOG_DIR}/mms_ping.log combined env=mmsbot
    ErrorLog ${APACHE_LOG_DIR}/man_page_ssl_errors.log

    RewriteEngine On

    # Strip query strings
    RewriteCond %{QUERY_STRING} .
    RewriteRule ^(.*)$ $1? [L]

    # Normalize man_page → man-page
    RewriteRule ^man_page(/.*)?$  man-page$1  [L]
    RewriteRule ^man_pages(/.*)?$ man-pages$1 [L]

    # Extracted logic blocks
    Include /etc/apache2/unix_redirect/kill_blocks.conf
    Include /etc/apache2/unix_redirect/proxy_blocks.conf
    Include /etc/apache2/unix_redirect/rails_static_aliases.conf

    # Kill full MMS folder
    RewriteCond %{REQUEST_URI} ^/mms/ [NC]
    RewriteRule .* - [G,L]

    # Homepage → community redirect
    RewriteCond %{HTTP_HOST} ^www\.unix\.com$ [NC]
    RewriteCond %{REQUEST_URI} ^/$
    RewriteRule ^/?$ https://community.unix.com/ [R=302,L]

    # Priority manpage routes
    Include /etc/apache2/unix_redirect/manpage_priority.conf

    # Redirect.php logic
    Include /etc/apache2/unix_redirect/redirect_logic.conf

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/unix.com-0001/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/unix.com-0001/privkey.pem
</VirtualHost>

